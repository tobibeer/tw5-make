/*\
title: $:/plugins/tobibeer/make/filters.js
type: application/javascript
module-type: filteroperator

a filter to generate tiddler titles

@preserve
\*/
(function(){"use strict";exports.make=function(e,t,i){var r,a,n,d,l,u,s,c,p=[],f=i.widget,m=i.wiki,o=[],x={inc:1,min:1,sep:" ",tiddler:f?f.getVariable("currentTiddler"):""},g=/\%TITLE\%/gim,h=/\%COUNT\%/gim,w=/\%DATE\%/gim,T=/\%UUID\%/gim,D=/\%MAX\%/gim,k=/RANDOM\((\d*)\)/gim,$=/\%TIDDLER\%/gim,b=/^\s*([\$\w\d\-\_\/]*):(.*)(?:\s*)$/,q=function(e,t){t=t||16;var i="",r=function(){var e=Math.floor(Math.random()*62);return e<10?e:e<36?String.fromCharCode(e+55):String.fromCharCode(e+61)};while(t--){i+=r()}return i},N=function(e,t){return m.getTextReference(t,"",x.tiddler)},v=function(e,t){return f?f.getVariable(t):""},C=function(e){return e.replace(/{{([^}]*)}}/gm,N).replace(/<<([^>]*)>>/gm,v)},E=function(e,t){var i,r=x.last||x.pad&&x.expr.indexOf("%count%")<0?x.pad:0,a=m.getTiddler(x.tiddler),n=x.uniq===1?m.getTiddlerData(x.tiddler,{}):0,d=x.last&&x.lastTitle==t?x.last:r?0:-1;do{d++;i=t+(d>0?x.sep+(r?$tw.utils.pad(d,r):d):"")}while(e.indexOf(i)>=0||x.uniq===undefined&&m.tiddlerExists(i)||x.uniq===0&&a.hasField(i)||x.uniq===1&&$tw.utils.hop(n,i));if(r){x.last=d;x.lastTitle=t}return i};e(function(e,t){p.push(t)});d=!(p.length===1&&!p[0]);try{$tw.utils.each((t.operand||"").split("\\"),function(e){var t;e=e.trim();if(e){l=b.exec(e);if(l){switch(l[1]){case"min":case"max":case"inc":t=parseInt(C(l[2]));if(isNaN(t)||t<1){t=1}x[l[1]]=t;break;case"sep":x.sep=l[2];break;case"unique":x.uniq=l[2]==="field"?0:1;break;case"pad":x.pad=parseInt(l[2]);break;case"tiddler":x.tiddler=l[2];break;case"date-format":x.dateFormat=l[2].trim();break}}else if(x.expr===undefined){x.expr=e}}});if(x.uniq===0){x.sep=x.sep===" "?"":x.sep.trim()}if(x.expr===undefined){x.expr="%tiddler%"}if(x.pad!==undefined&&isNaN(x.pad)){x.pad=x.max?x.max.toString().length:2}if(d){x.max=x.max?Math.min(p.length,x.max):p.length}if(!x.max||x.max<x.min){x.max=x.min}s=new Date;n=s;x.count=x.min;u=k.test(x.expr);if(w.test(x.expr)){r=x.dateFormat?$tw.utils.formatDateString(s,x.dateFormat):$tw.utils.stringifyDate(s)}c=T.test(x.expr);do{a=C(x.expr);if(u){a=a.replace(k,q)}if(c){a=a.replace(T,$tw.utils.uuid())}a=E(o,a.replace($,x.tiddler).replace(g,d?p[x.count-1]:x.tiddler).replace(D,x.max).replace(h,x.pad?$tw.utils.pad(x.count,x.pad):x.count).replace(w,r));o.push(a);x.count=x.count+x.inc;if(x.count%500===0){n=new Date}}while(x.count<=x.max&&n-s<5e3)}catch(I){return["Error in make filter:\n"+I]}return o}})();